<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Bitcoin Macro Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'SF Pro Display', sans-serif;
            background: linear-gradient(145deg, #0d0d0d 0%, #1a1a2e 50%, #0d0d0d 100%);
            min-height: 100vh;
            color: #fff;
            padding: 15px;
        }
        
        .container { max-width: 600px; margin: 0 auto; }
        
        h1 {
            text-align: center;
            font-size: 1.6em;
            margin-bottom: 5px;
            background: linear-gradient(90deg, #f7931a, #ffab40);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .subtitle {
            text-align: center;
            color: #666;
            font-size: 0.8em;
            margin-bottom: 20px;
        }
        
        .card {
            background: rgba(255,255,255,0.04);
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 15px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        
        .card-title {
            font-size: 0.75em;
            color: #888;
            text-transform: uppercase;
            letter-spacing: 1.5px;
            margin-bottom: 12px;
        }
        
        .price-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .price-label { color: #aaa; font-size: 0.9em; }
        
        .price-value {
            font-size: 1.3em;
            font-weight: 600;
        }
        
        .btc { color: #f7931a; }
        .gold { color: #ffd700; }
        .ratio { color: #4ade80; }
        .neutral { color: #fff; }
        .liquidity { color: #60a5fa; }
        
        .highlight-card {
            background: linear-gradient(135deg, rgba(247,147,26,0.15) 0%, rgba(247,147,26,0.05) 100%);
            border-color: rgba(247,147,26,0.3);
            text-align: center;
            padding: 25px;
        }
        
        .big-number {
            font-size: 3em;
            font-weight: 700;
            color: #f7931a;
        }
        
        .big-label {
            font-size: 0.85em;
            color: #aaa;
            margin-top: 5px;
        }
        
        .change {
            font-size: 0.8em;
            padding: 3px 8px;
            border-radius: 8px;
            margin-left: 8px;
        }
        
        .change.up { background: rgba(74,222,128,0.2); color: #4ade80; }
        .change.down { background: rgba(239,68,68,0.2); color: #ef4444; }
        
        .mini-chart {
            height: 60px;
            background: rgba(255,255,255,0.03);
            border-radius: 8px;
            margin-top: 15px;
            display: flex;
            align-items: flex-end;
            padding: 5px;
            gap: 2px;
        }
        
        .bar {
            flex: 1;
            background: linear-gradient(to top, #f7931a, #ffab40);
            border-radius: 2px 2px 0 0;
            min-height: 5px;
        }
        
        .metrics-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .metric-box {
            background: rgba(255,255,255,0.03);
            padding: 12px;
            border-radius: 10px;
            text-align: center;
        }
        
        .metric-value {
            font-size: 1.2em;
            font-weight: 600;
            color: #fff;
        }
        
        .metric-label {
            font-size: 0.7em;
            color: #888;
            margin-top: 4px;
        }
        
        .power-law-gauge {
            height: 8px;
            background: linear-gradient(90deg, #22c55e 0%, #eab308 50%, #ef4444 100%);
            border-radius: 4px;
            margin: 15px 0;
            position: relative;
        }
        
        .gauge-marker {
            position: absolute;
            top: -4px;
            width: 16px;
            height: 16px;
            background: #fff;
            border-radius: 50%;
            transform: translateX(-50%);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        
        .gauge-labels {
            display: flex;
            justify-content: space-between;
            font-size: 0.65em;
            color: #666;
        }
        
        .section-divider {
            height: 1px;
            background: rgba(255,255,255,0.1);
            margin: 20px 0;
        }
        
        .info-text {
            font-size: 0.75em;
            color: #666;
            text-align: center;
            margin-top: 15px;
            line-height: 1.4;
        }
        
        .update-time {
            text-align: center;
            font-size: 0.7em;
            color: #444;
            margin-top: 20px;
        }
        
        .nav-links {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .nav-links a {
            color: #888;
            text-decoration: none;
            font-size: 0.8em;
            padding: 5px 12px;
            border-radius: 15px;
            background: rgba(255,255,255,0.05);
        }
        
        .nav-links a.active {
            color: #f7931a;
            background: rgba(247,147,26,0.15);
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚Çø Macro Dashboard</h1>
        <p class="subtitle">Bitcoin ‚Ä¢ Gold ‚Ä¢ Liquidity</p>
        
        <div class="nav-links">
            <a href="index.html">Power Law</a>
            <a href="energy-metrics.html">Energy</a>
            <a href="macro.html" class="active">Macro</a>
            <a href="gold.html">vs Gold</a>
        </div>
        
        <!-- BTC/Gold Ratio Card -->
        <div class="card highlight-card">
            <div class="card-title">‚Çø Bitcoin / Gold Ratio</div>
            <div class="big-number" id="btc-gold-ratio">--</div>
            <div class="big-label">ounces of gold per BTC</div>
        </div>
        
        <!-- BTC/Gold Ratio Chart -->
        <div class="card">
            <div class="card-title">üìà BTC/Gold Ratio (90 Days)</div>
            <div style="height: 200px; position: relative;">
                <canvas id="ratio-chart"></canvas>
            </div>
            <div class="info-text" id="chart-info">Loading chart...</div>
        </div>
        
        <!-- Price Comparison -->
        <div class="card">
            <div class="card-title">üí∞ Current Prices</div>
            <div class="price-row">
                <span class="price-label">Bitcoin (BTC)</span>
                <span class="price-value btc" id="btc-price">$--</span>
            </div>
            <div class="price-row">
                <span class="price-label">Gold (XAU/oz)</span>
                <span class="price-value gold" id="gold-price">$--</span>
            </div>
            <div class="price-row">
                <span class="price-label">Silver (XAG/oz)</span>
                <span class="price-value neutral" id="silver-price">$--</span>
            </div>
            
            <div class="section-divider"></div>
            
            <div class="metrics-grid">
                <div class="metric-box">
                    <div class="metric-value" id="btc-oz-ratio">--</div>
                    <div class="metric-label">BTC in Gold oz</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value" id="btc-silver-ratio">--</div>
                    <div class="metric-label">BTC in Silver oz</div>
                </div>
            </div>
        </div>
        
        <!-- Power Law Position (mini) -->
        <div class="card">
            <div class="card-title">üìä Power Law Position</div>
            <div class="price-row">
                <span class="price-label">Fair Value</span>
                <span class="price-value neutral" id="fair-value">$--</span>
            </div>
            <div class="price-row">
                <span class="price-label">Current vs Fair</span>
                <span class="price-value" id="fair-diff">--%</span>
            </div>
            <div class="power-law-gauge">
                <div class="gauge-marker" id="pl-marker" style="left: 50%;"></div>
            </div>
            <div class="gauge-labels">
                <span>Undervalued</span>
                <span>Fair</span>
                <span>Overvalued</span>
            </div>
        </div>
        
        <!-- Fed Net Liquidity -->
        <div class="card">
            <div class="card-title">üåä Fed Net Liquidity</div>
            <div class="price-row">
                <span class="price-label">Fed Balance Sheet</span>
                <span class="price-value liquidity" id="fed-balance">$--</span>
            </div>
            <div class="price-row">
                <span class="price-label">‚àí Reverse Repo (RRP)</span>
                <span class="price-value neutral" id="rrp">$--</span>
            </div>
            <div class="price-row">
                <span class="price-label">‚àí Treasury (TGA)</span>
                <span class="price-value neutral" id="tga">$--</span>
            </div>
            <div class="section-divider"></div>
            <div class="price-row">
                <span class="price-label"><strong>= Net Liquidity</strong></span>
                <span class="price-value liquidity" id="net-liquidity" style="font-size: 1.5em;">$--</span>
            </div>
            <div class="info-text" id="liquidity-info">
                üí° Net Liquidity = Fed Balance Sheet ‚àí RRP ‚àí TGA<br>
                Bitcoin correlates strongly with Fed liquidity flows.
            </div>
        </div>
        
        <!-- ISM PMI -->
        <div class="card">
            <div class="card-title">üè≠ ISM Manufacturing PMI</div>
            <div class="metrics-grid">
                <div class="metric-box">
                    <a href="https://www.investing.com/economic-calendar/ism-manufacturing-pmi-173" target="_blank" style="color: #60a5fa; text-decoration: none;">
                        <div class="metric-value">üìä</div>
                        <div class="metric-label">Latest PMI</div>
                    </a>
                </div>
                <div class="metric-box">
                    <a href="https://tradingview.com/symbols/ECONOMICS-USBCOI/" target="_blank" style="color: #ffd700; text-decoration: none;">
                        <div class="metric-value">üìà</div>
                        <div class="metric-label">Chart History</div>
                    </a>
                </div>
            </div>
            <div class="info-text">
                üí° PMI > 50 = expansion, < 50 = contraction<br>
                ISM data is proprietary ‚Äî links to free sources above
            </div>
        </div>
        
        <!-- Market Context -->
        <div class="card">
            <div class="card-title">üìà Market Context</div>
            <div class="metrics-grid">
                <div class="metric-box">
                    <div class="metric-value" id="gold-btc-mcap">--</div>
                    <div class="metric-label">Gold vs BTC MCap</div>
                </div>
                <div class="metric-box">
                    <div class="metric-value" id="btc-dominance">--</div>
                    <div class="metric-label">BTC Dominance</div>
                </div>
            </div>
            <div class="info-text" style="margin-top: 12px;">
                Gold market cap: ~$17T | BTC market cap: ~$1.7T<br>
                BTC = ~10% of gold. Room to grow? üöÄ
            </div>
        </div>
        
        <div class="update-time" id="update-time">Loading...</div>
    </div>
    
    <script>
        // ============================================
        // FRED API KEY - Get free key at:
        // https://fred.stlouisfed.org/docs/api/api_key.html
        // ============================================
        const FRED_API_KEY = ''; // Paste your key here
        
        // Power Law calculation (same as main app)
        function getPowerLawFairValue() {
            const genesisDate = new Date('2009-01-03');
            const today = new Date();
            const daysSinceGenesis = Math.floor((today - genesisDate) / (1000 * 60 * 60 * 24));
            // Power Law: price = 10^(a + b * log10(days))
            const a = -17.01;
            const b = 5.82;
            return Math.pow(10, a + b * Math.log10(daysSinceGenesis));
        }
        
        // Format trillions
        function formatT(billions) {
            return '$' + (billions / 1000).toFixed(2) + 'T';
        }
        
        // Fetch FRED series (returns latest value in billions)
        async function fetchFRED(series) {
            if (!FRED_API_KEY) return null;
            try {
                const url = `https://api.stlouisfed.org/fred/series/observations?series_id=${series}&api_key=${FRED_API_KEY}&file_type=json&sort_order=desc&limit=1`;
                const res = await fetch(url);
                const data = await res.json();
                if (data.observations && data.observations.length > 0) {
                    const val = parseFloat(data.observations[0].value);
                    return isNaN(val) ? null : val / 1000; // Convert millions to billions
                }
            } catch (e) {
                console.error('FRED fetch error:', series, e);
            }
            return null;
        }
        
        // Fetch Fed Liquidity data
        async function fetchLiquidity() {
            if (!FRED_API_KEY) {
                document.getElementById('liquidity-info').innerHTML = 
                    '‚ö†Ô∏è Add FRED API key for live data<br>' +
                    '<a href="https://fred.stlouisfed.org/docs/api/api_key.html" target="_blank" style="color: #60a5fa;">Get free key (30 sec) ‚Üí</a>';
                return;
            }
            
            try {
                // Fetch all three in parallel
                const [balance, rrp, tga] = await Promise.all([
                    fetchFRED('WALCL'),    // Fed Balance Sheet (millions, weekly)
                    fetchFRED('RRPONTSYD'), // Reverse Repo (billions, daily)
                    fetchFRED('WTREGEN')    // TGA (millions, weekly)
                ]);
                
                if (balance !== null) {
                    document.getElementById('fed-balance').textContent = formatT(balance);
                }
                if (rrp !== null) {
                    // RRP is already in billions
                    document.getElementById('rrp').textContent = formatT(rrp * 1000);
                }
                if (tga !== null) {
                    document.getElementById('tga').textContent = formatT(tga);
                }
                
                // Calculate Net Liquidity
                if (balance !== null && rrp !== null && tga !== null) {
                    const netLiq = balance - (rrp * 1000) - tga; // All in billions
                    document.getElementById('net-liquidity').textContent = formatT(netLiq);
                    document.getElementById('liquidity-info').innerHTML = 
                        'üí° Net Liquidity = Fed Balance Sheet ‚àí RRP ‚àí TGA<br>' +
                        'Bitcoin correlates strongly with Fed liquidity flows.';
                }
            } catch (e) {
                console.error('Liquidity fetch error:', e);
            }
        }
        
        // PMI - ISM data is proprietary, show link to free sources
        async function fetchPMI() {
            // Note: ISM PMI is proprietary data - no free real-time API
            // Best free sources: TradingView, Investing.com economic calendar
        }
        
        // BTC/Gold Ratio Chart
        let ratioChart = null;
        
        async function fetchRatioChart() {
            try {
                document.getElementById('chart-info').textContent = 'Loading historical data...';
                
                // Fetch 90 days of BTC price history from CoinGecko
                const btcRes = await fetch('https://api.coingecko.com/api/v3/coins/bitcoin/market_chart?vs_currency=usd&days=90&interval=daily');
                const btcData = await btcRes.json();
                
                // For gold, we'll use a more stable estimate (gold moves slowly)
                // CoinGecko doesn't have gold history, so we fetch current and estimate backwards
                const goldRes = await fetch('https://data-asg.goldprice.org/dbXRates/USD');
                const goldData = await goldRes.json();
                const currentGold = goldData.items[0].xauPrice;
                
                // Calculate BTC/Gold ratios
                const ratios = btcData.prices.map(([timestamp, btcPrice]) => {
                    // Approximate gold price (gold is relatively stable, ~¬±5% over 90 days)
                    const goldPrice = currentGold; // Simplified - could add variance
                    return {
                        date: new Date(timestamp),
                        ratio: btcPrice / goldPrice
                    };
                });
                
                // Prepare chart data
                const labels = ratios.map(r => r.date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' }));
                const data = ratios.map(r => r.ratio);
                
                // Calculate stats
                const minRatio = Math.min(...data);
                const maxRatio = Math.max(...data);
                const avgRatio = data.reduce((a, b) => a + b, 0) / data.length;
                
                // Create/update chart
                const ctx = document.getElementById('ratio-chart').getContext('2d');
                
                if (ratioChart) {
                    ratioChart.destroy();
                }
                
                ratioChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'BTC/Gold Ratio',
                            data: data,
                            borderColor: '#f7931a',
                            backgroundColor: 'rgba(247, 147, 26, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.3,
                            pointRadius: 0,
                            pointHoverRadius: 4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: (ctx) => ctx.parsed.y.toFixed(1) + ' oz gold/BTC'
                                }
                            }
                        },
                        scales: {
                            x: {
                                display: true,
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { 
                                    color: '#666',
                                    maxTicksLimit: 6,
                                    font: { size: 10 }
                                }
                            },
                            y: {
                                display: true,
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { 
                                    color: '#666',
                                    font: { size: 10 },
                                    callback: (v) => v.toFixed(0)
                                }
                            }
                        },
                        interaction: {
                            intersect: false,
                            mode: 'index'
                        }
                    }
                });
                
                document.getElementById('chart-info').innerHTML = 
                    `90d range: <span style="color:#4ade80">${minRatio.toFixed(1)}</span> ‚Äì <span style="color:#ef4444">${maxRatio.toFixed(1)}</span> oz | Avg: ${avgRatio.toFixed(1)} oz`;
                
            } catch (error) {
                console.error('Chart error:', error);
                document.getElementById('chart-info').textContent = 'Error loading chart data';
            }
        }
        
        async function fetchData() {
            try {
                // Fetch BTC price
                const btcRes = await fetch('https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd&include_market_cap=true');
                const btcData = await btcRes.json();
                const btcPrice = btcData.bitcoin.usd;
                const btcMcap = btcData.bitcoin.usd_market_cap;
                
                // Fetch Gold price
                const goldRes = await fetch('https://data-asg.goldprice.org/dbXRates/USD');
                const goldData = await goldRes.json();
                const goldPrice = goldData.items[0].xauPrice;
                const silverPrice = goldData.items[0].xagPrice;
                
                // Calculate ratios
                const btcGoldRatio = btcPrice / goldPrice;
                const btcSilverRatio = btcPrice / silverPrice;
                
                // Power Law
                const fairValue = getPowerLawFairValue();
                const fairDiff = ((btcPrice - fairValue) / fairValue) * 100;
                
                // Update DOM
                document.getElementById('btc-price').textContent = '$' + btcPrice.toLocaleString(undefined, {maximumFractionDigits: 0});
                document.getElementById('gold-price').textContent = '$' + goldPrice.toLocaleString(undefined, {maximumFractionDigits: 2});
                document.getElementById('silver-price').textContent = '$' + silverPrice.toLocaleString(undefined, {maximumFractionDigits: 2});
                
                document.getElementById('btc-gold-ratio').textContent = btcGoldRatio.toFixed(1);
                document.getElementById('btc-oz-ratio').textContent = btcGoldRatio.toFixed(1) + ' oz';
                document.getElementById('btc-silver-ratio').textContent = btcSilverRatio.toFixed(0) + ' oz';
                
                document.getElementById('fair-value').textContent = '$' + fairValue.toLocaleString(undefined, {maximumFractionDigits: 0});
                
                const fairDiffEl = document.getElementById('fair-diff');
                fairDiffEl.textContent = (fairDiff >= 0 ? '+' : '') + fairDiff.toFixed(1) + '%';
                fairDiffEl.style.color = fairDiff >= 0 ? '#4ade80' : '#ef4444';
                
                // Position gauge marker (0-100%, with 50% being fair value)
                // Map -50% to +100% range to 0-100% position
                const markerPos = Math.max(0, Math.min(100, 50 + (fairDiff / 2)));
                document.getElementById('pl-marker').style.left = markerPos + '%';
                
                // Market context
                const goldMcap = 17; // trillion
                const btcMcapT = btcMcap / 1e12;
                document.getElementById('gold-btc-mcap').textContent = (goldMcap / btcMcapT).toFixed(1) + 'x';
                document.getElementById('btc-dominance').textContent = '~55%';
                
                document.getElementById('update-time').textContent = 'Updated: ' + new Date().toLocaleTimeString();
                
            } catch (error) {
                console.error('Error:', error);
                document.getElementById('update-time').textContent = 'Error loading data';
            }
        }
        
        // Initial load
        fetchData();
        fetchLiquidity();
        fetchRatioChart();
        
        // Refresh every 2 minutes (chart less frequently - API limits)
        setInterval(fetchData, 2 * 60 * 1000);
        setInterval(fetchLiquidity, 5 * 60 * 1000);
        setInterval(fetchRatioChart, 10 * 60 * 1000);
    </script>
</body>
</html>
